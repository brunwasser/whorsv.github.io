---
title: "Analytic Summary"
---

```{r set-options, echo=F}
options(width = 145)
```

# Overview
This page presents a step-by-step summary of the analytic procedures for the paper: _Assessing causal inference of respiratory syncytial virus lower respiratory tract infection on subsequent wheezing illness using meta analytic strategies_. The R code for all output can be accessed by clicking on the corresponding "Code" buttons. The analyses can be reproduced within the R environment using these codes and the required packages (see section 3 below). The primary analytic models were Robust Variance Estimation (RVE) [(Hedges et al. 2010)](https://www.ncbi.nlm.nih.gov/pubmed/26056092) meta-regressions run using the [robumeta](https://cran.r-project.org/web/packages/robumeta/robumeta.pdf) package version 2.0. [Fisher & Tipton 2015](robumeta: an R package for robust variance estimation in meta-analysis) provide a guide for using the *robumeta* package. A detailed rationale for using the RVE approach is provided in our study protocol. 

# Variable Key
These are the variable names for the primary variables included the study analyses. You will see these variable in R code in the analyses below.

* *logor*: Continuous variable representing the primary effect size (log~e~ of the odds ratio)
* *surveil*: Binary factor distinguishing between the two types of *RSV LRTI Exposure* studies -- *Medical Event* and *Surveillance* studies
* *outagecat2f*: 3-level factor indicating whether the outcome variables was measured in the following age groups: Preschool (median age 0-5), School Age (6-12), and Adolescence/Adulthood (13+)
* *exp012*: Binary factor indicating whether the exposure ascertainment period was entirely contained within the first 12 months of life or whether it extended beyond 12 months
* *participantrisk*: Binary factor indicating whether the study enrolled only individuals with a known risk factor for asthma (other than RSV LRTI) or whether enrollment was not risk-based
* *minanygen*: Binary factor indicating whether or not the effect size estimate was based on an analysis that minimized potential genetic confounding to any degree
* *minanycoinf*: Binary factor indicating whether or not the effect size estimate was based on an analysis that minimized potential confounding due to the presence of co-infections
* *minanyneo*: Binary factor indicating whether or not the effect size estimate was based on an analysis that minimized potential confounding due to differences in the exposed and comparator groups in markers of neonatal health (e.g., Apgar scores)
* *rct*: Binary factor distinguishing between *RSV Prophylaxis* studies using a randomized controlled design vs. a non-randomized design
* *comptype*: 3-level factor distinguishing between the 3 primary study design types: *RSV Medical Event*, *RSV Surveillance* studies, and *RSV Prophylaxis* studies

# Workspace preparation steps
1. Clear the workspace
2. Load the necessary data files
3. Load all required packages (note: you may have to install these packages first using the [install.packages()](https://www.rdocumentation.org/packages/utils/versions/3.6.1/topics/install.packages) function)

```{r warning=FALSE, message=FALSE}
## Clear workspace
rm(list=ls())

## Load the primary data set
whoprimary1 <- read.csv( 'https://www.dropbox.com/s/0emcoq7z7g7lst2/whoprimary1.csv?dl=1' )
## Load data for subgroup analyses
whoatopy <- read.csv( 'https://www.dropbox.com/s/xu3pssx56mzhg6g/whoatopy.csv?dl=1')
## Load data for plotting results from leave-one-out analyses
looplotdf <- read.csv( 'https://www.dropbox.com/s/4l9ki93tnhbdatf/looplotdf1.csv?dl=1' )
## Load data for plotting RSV Immunoprophylaxis forest plot
prophylplot1 <- read.csv( 'https://www.dropbox.com/s/ryr9lojqeggi3bg/whoprophyl1.csv?dl=1' )

## Load necessary packages
library( robumeta );library( metafor );library( clubSandwich );library( ggplot2 );library( metaviz );library( psych );library( qqplotr )
```

# Preliminary steps and data visualization

Firsty, we create a new variable based on the *comptype* variable distinguishing design types that is specifically for the purpose of plotting.

```{r}
whoprimary1$Design <- whoprimary1$comptype
levels( whoprimary1$Design ) <- c( 'RSV Immunoprophylaxis','RSV Medical Event','RSV Surveillance' )
```

Next, we create an inverse standard error weight variable to show approximately how much weight each estimate would carry (i.e., how precise it is) for plotting (not analytic) purposes. The standard error for each log odds ratio effect size estimate is contained in the *se_logor* variable.

```{r}
whoprimary1$w <- whoprimary1$se_logor^-1
```

Make a boxplot figure of the log odds ratio estimates by study design to get a sense of how the data are distributed. We'll use the newly created inverse standard error variable to determine the size of the points in the plot, with point size increasing with the precision of the estimate.

```{r}
( box1 <- ggplot( whoprimary1, aes( x=Design, y=logor ) ) +
  geom_boxplot( outlier.shape = NA )  +
    geom_point( aes(size = whoprimary1$w ),  shape = 1,  position = position_jitterdodge(),
                show.legend = F ) +
    ggtitle( 'Distribution of Effect Sizes by Study Design') +
    ylab( 'Natural Log of the Odds Ratio' ) +
    theme( plot.title = element_text( size=16, face='bold' ),
           axis.title.x = element_blank(),
           axis.title.y = element_text( size=14, face='bold' ),
           axis.text.x = element_text( size=12, face='bold') )
)
```

Most of the estimates are greater than 0, indicating a potential positive association between RSV LRTI exposure and subsequent wheezing illness, but there are a number of estimates less than 0 as well. The median effect size appears to be largest in the *RSV Medical Event* studies. There are a couple of imprecise estimates (small points) within the *RSV Medical Event* and *RSV Surveillance* studies that are positive outliers. Notably, several of the most precise estimates (i.e., largest points) within the *RSV Immunoprophylaxis* studies are < 0. Thus, for these specific estimates, individuals **NOT** receiving immunuprophylaxis (the group that presumably has greater exposure to *RSV LRTI*) have lower odds of subsequent wheezing illness relative to those receiving immunoprophylaxis. Assuming other factors affecting level of RSV LRTI exposure are balanced across the exposure and comparator groups, we would expect individuals **not** receiving immunoprophylaxis to have greater risk for subsequent wheezing illness if *RSV LRTI* were a causal contributor.
<br>
<br>
To get a better sense of potential deviations from normality, we make a Q-Q plot of the log odds ratio distributions by study design.
```{r fig.width=10, fig.height=8}
( qq1 <- ggplot( whoprimary1, aes( sample = logor ) ) +
    facet_wrap( ~Design ) +
    stat_qq_band() +
    stat_qq_line() +
    stat_qq_point() +
    labs( title = 'Q-Q Plot: Log Odds Ratio Distributions by Study Design',
          subtitle = '95% Confidence Bands' ) +
    #gtitle( 'Q-Q Plot of Log Odds Ratio Distributions' ) +
    labs(x = "Theoretical Quantiles", y = "Sample Quantiles") +
    theme( strip.text.x = element_text( size = 12, face = 'bold' ),
           axis.title.x = element_text( size = 16, face = 'bold' ),
           axis.title.y = element_text( size = 16, face = 'bold' ),
           plot.title = element_text( size = 16, face = 'bold' ) )
 )
```

The estimates appear to be relatively normally distributed, though there is some evidence of deviation in the tails of the distributions, particularly among the *RSV Surveillance* studies. We will conduct analyses to determine whether any estimates have sufficient leverage to meaningfully alter our analytic conclusions (section 5.1.2). 

# Meta-Regression Analyses
## *RSV Exposure* studies
In this section, we evaluate whether there is evidence that confirmed RSV LRTI is positively associated with subsequent wheezing illness in observational studies and whether effect modifiers representing potential non-causal explanations for this association account for heterogeneity in the effect size estimates. There are 36 *RSV Exposure* studies providing 134 estimates for the primary analyses. Note: One of the two RSV Immunoprophylaxis RCTs provided an estimate of the direct association between RSV LRTI and subsequent wheezing illness, and therefore contributed one estimate to the *RSV LRTI Exposure* analyses.

###Primary (*a priori*) model
The *a priori* model for the *RSV Exposure* studies was as follows:

**$y^{ij} = \gamma_{00} + \gamma_{10} x_{1}^{ij} + \gamma_{20} x_{2}^{ij} + \gamma_{30} x_{3}^{ij} + \gamma_{40} x_{4}^{ij} + \gamma_{50} x_{5}^{ij} + \gamma_{01} w_{1}^{j} + \gamma_{02} w_{2}^{j} + \gamma_{60} (x_{1}^{ij}\times x_{2}^{ij}) + \gamma_{11} (x_{1}^{ij}\times w_{2}^{j}) + e^{ij} + u^j$**

where y^ij^ = log~e~(OR) for effect size estimate i within study j; $\gamma$~00~ = conditional mean of the distribution of population effect sizes; $\gamma$~10~ ...$\gamma$~60~ = regression parameters for covariates (x^ij^) whose values vary within studies; $\gamma$~01~, $\gamma$~02~ = regression parameters for covariates (w^j^) whose values are constant within studies; $\gamma$~11~ = regression parameter for a cross-level interaction; e^ij^ = within-study sampling error;  u^j^ = between-study deviations from the population average effect size. The model covariates (effect modifiers) are defined as follows:

* x~1~^ij^ = study design: 0=exposure group membership determined by RSV LRTI medical event; 1= exposure group membership determined by viral surveillance
* x~2~^ij^ = age at outcome ascertainment: 0=preschool years (mean/median age < 5); 1=primary school years (mean/median age $\geq$ 5); 2=adolescence/adulthood (mean/median age $\geq$ 13)
* x~3~^ij^ = genetic confounding: 0=no clear attempt to limit potential genetic confounding; 1=confounding limited at least somewhat
* x~4~^ij^ = co-infection confounding: 0=no attempt to limit potential confounding due to co-infections at time of RSV+ LRTI ascertainment; 1= confounding limited at least somewhat
* x~5~^ij^ = neonatal health confounding: 0=no attempt to limit potential confounding due to infant neonatal health; 1= confounding limitd at least somewhat
* w~1~^j^ = participant risk: 0=study included children regardless of risk status; 1=study included only children at risk for asthma beyond having an RSV LRTI; 
* w~2~^j^ = exposure ascertainment period: 0=study exposure ascertainment extends beyond 12 months of age; 1= exposure ascertainment entirely within the first 12 months of life.
* e^ij^ = within-study sampling error;
* u^j^ = between-study deviations from the population average effect size


Create a data frame (*whorsvexp*) with only RSV+ Exposure studies
```{r}
whorsvexp <- subset( whoprimary1, rsvexp == 'RSV Exposure Studies' )
levels( whorsvexp$surveil ) <- c( 'RSV+ Medical Event','RSV+ Surveillance' )
levels( whorsvexp$exp012) <- c( 'Exposure period 0-12 months','Exposure period beyond 12 months')
```

Prior to conducting our Robust Variance Estimation (RVE) meta-regression, it is critical to evaluate the distributions of the potential effect modifiers (covariates in the above equation). Our RVE models calculate degrees of freeedom (*df*) using Satterthwaite approximation. Estimates with *df* < 4 should not be trusted [(Tipton, 2015)](https://www.ncbi.nlm.nih.gov/pubmed/?term=tipton+2015+robust+variance+estimation). Imbalance and sparse cells in the covariates could be a cause of insufficient *df*. 

There is notable imbalance in the variables coding age category at outcome ascertainment (i.e., relatively few estimates measured in Adolescence/Adulthood) and minimization of confouding due to co-infection (i.e., few studies minimized this potential confounder). We will run the *a priori* model as is and note whether the *df* indicate a problem.

```{r}
( toutagecat2 <- with( whorsvexp, table( outagecat2f ) ) )
( tminanycoinf <- with( whorsvexp, table( minanycoinff ) ) )

par( mfrow = c(1,1))
barplot( toutagecat2, main = 'Age Category at Outcome Measurement' )
barplot( tminanycoinf, main = 'Any Evidence Co-Infection Confounding Reduced' )
```


**Model 1.0:** Prior to running the *a priori* model, we first run a model with no effect modifiers to calculate the unconditional weighted mean log~e~OR.
```{r }
model1.0 <- robu( logor ~ 1, data = whorsvexp, studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) 

print( model1.0 )
```

To aid in interpretation, we exponentiate the log~e~OR estimate to transform the estimate to an odds ratio.

```{r}
( model1.0.df <- data.frame( OddsRatioEstimate=round( exp( model1.0$reg_table$b.r ), digits = 2 ), 
                           LCI=round( exp( model1.0$reg_table$CI.L ), digits = 2 ),
                           UCI=round( exp( model1.0$reg_table$CI.U ), digits = 2 ) ) )
```

In the unconditional model, RSV LRTI exposure is associated with a 3.29-fold increase in odds of subsequent wheezing illness (95% CI: 2.63, 4.12). 

**Model 1.1:** We run the *a priori* model for *RSV LRTI Exposure* studies using the [robumeta](https://cran.r-project.org/web/packages/robumeta/index.html) package in R. We use a simple working model of the within-study correlation matrix (set all within-study correlations to $\rho$ = 0.80) in order to get optimally efficient inverse variance weights. We identify the *studyid* variable as the clustering variable and use small-sample-size corrections [(Tipton, 2015)](https://www.ncbi.nlm.nih.gov/pubmed/24773356).
```{r }
model1.1 <- robu( logor ~ surveil*outagecat2f + surveil*exp012 + minanygen + minanycoinf + minanyneo + participantrisk, data = whorsvexp, studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) 

print( model1.1 )
```

The *df* for the estimates of the effect modifier coding age category at outcome ascertainment (*outagecat2f*) are too small to be trusted (*df*=1.91 & 1.94). This may be due to the fact that there is high imbalance across the levels of this factor, with few estimates measuring effects in adolescence/adulthood. 

**Model 1.2:** We rerun Model 1.1 after collapsing the *school age* and *adolescence/adulthood* categories with the variable *preschool*. This effect modifier now tests whether effect sizes are larger among estimates measured outside of the preschool years: preschool vs. schoolage/adolescence/adulthood. This may fix the *df* problem. Additionally, we dropped the two interaction terms as there was no evidence that they were significant and they had relatively small *df*.

```{r}
model1.2 <- robu( logor ~ surveil + preschool + surveil + exp012 + minanygen + minanycoinf + minanyneo + participantrisk, data = whorsvexp, studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) 

print( model1.2 )
```

In both versions of the model (Model 1.1 and Model 1.2), the full confidence interval for the intercept---representing the weighted mean log odds ratio when all effect modifiers are set to the reference category---is positive, suggesting a positive association between RSV LRTI exposure and subsequent wheezing illness. We can convert the intercept estimate to the OR scale by exponentiating it:

```{r}
model1.2.est <- round( exp( c(model1.2$reg_table$b.r[1]) ), digits = 2  )
model1.2.lci <- round( exp( c(model1.2$reg_table$CI.L[1]) ), digits = 2  )
model1.2.uci <- round( exp( c(model1.2$reg_table$CI.U[1]) ), digits = 2  )
## Estimates on the OR scale
( model1.2.table <- data.frame(parameter=model1.2$reg_table$labels[1], ConditionalOddsRatio=model1.2.est[1], LCI=model1.2.lci[1], UCI=model1.2.uci[1] ) )
```

The conditional weighted mean OR = 4.26 (95% CI: 2.41, 7.54) when holding all effect modifiers at their reference levels.

Effect size estimates were smaller among studies minimizing genetic confounding. This is consistent with the hypothesis that RSV LRTI exposure is at least partly a marker of genetic susceptibility rather than a purely causal factor. There was no evidence of effect modification by whether estimates were based on analyses limiting the influence non-RSV co-infections or neonatal health markers. Although these effect modifiers did not represent primary hypotheses, estimates from studies using a targeted enrollment strategy (i.e., enrolling only those with a known risk factor for wheezing illness other than RSV LRTI exposure: *participantrisk*) and those in which the entire exposure ascertainment period was contained in the first 12 months of life (*exp012*) yielded smaller effect sizes. 


**Model 1.3:** To gauge how much the expected weighted mean effect size drops when limiting genetic confounding, we reran Model 1.2 changing the reference level of the *miananygen* variable so that limiting potential genetic confounding at least somewhat was the reference level and not limiting genetic confounding was the comparison level. The intercept in this model represents the condition weighted mean effect size estimate when studies minimized genetic confounding (adjusting for all other effect modifiers). 

```{r}
model1.3 <- robu( logor ~ surveil + preschool + surveil + exp012 + minanygenrev + minanycoinf + minanyneo + participantrisk, data = whorsvexp, studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) 

print( model1.3 )

model1.3.est <- round( exp( c(model1.3$reg_table$b.r[1]) ), digits = 2  )
model1.3.lci <- round( exp( c(model1.3$reg_table$CI.L[1]) ), digits = 2  )
model1.3.uci <- round( exp( c(model1.3$reg_table$CI.U[1]) ), digits = 2  )
## Estimates on the OR scale
( model1.3.table <- data.frame(parameter=model1.3$reg_table$labels[1], ConditionalOddsRatio=model1.3.est[1], LCI=model1.3.lci[1], UCI=model1.3.uci[1] ) )
```


The intercept in Model 1.3 is smaller when it represents the weighted mean effect size among studies limiting genetic confounding compared to Model 1.2 when it represents studies not limiting genetic confounding. The point estimate for the intercept drops from aOR=4.26 in Model 1.2 to aOR=2.44 in Model 1.3. The intercept is positive and signifcant in both models, indicating a positive conditional mean effect between RSV LRTI and subsequent wheezing illness. But we expect a substantial drop in the OR for the effect of RSV LRTI on subsequent wheezing illness when studies do something to limit genetic confounding. 


Below we visualize the modifying effect of limiting genetic confounding by plotting boxplots for the observared effect size estimates by whether or not the estimates limited genetic confounding. We superimpose the point estimates to show the observed distributions with the point size proportional to the estimate's inverse variance -- i.e., more precise estimates have larger points. Additionally, we superimpose red diamonds, the center of which represents the estimated conditional mean effect size estimates based on models 1.2 and 1.3. The bottoms and tops of the diamonds represent, respectively, the lower and upper bound 95% confidence intervals. Finally, we highlight in red the estimate from the study by [Poorisrisak et al. 2010](https://www.ncbi.nlm.nih.gov/pubmed/?term=poorisrisak+twin+rsv+asthma) because this was the only estimate that fully eliminated genetic confounding by comparing monozygotic twins who were discordant for RSV LRTI hospitalization. This point estimate was smaller than over 80% of the estimates that only partly limited genetic confounding. As the sample size was relatively small in this study, there was considerable uncertainty in this estimate with plausible odds ratios ranging from RSV LRTI hospitalization being protective (lower 95% CI = 0.36) to highly damaging (upper 95% CI = 4.00). 
```{r warning=F}
whorsvexp$minanygenf <- relevel( whorsvexp$minanygenf, ref='Not minimized')
mingenfull <- with( whorsvexp, ifelse( studyname == 'Poorisrisak 2010', 1, 0 ) )#
mingenfullf <- factor( mingenfull, levels=0:1, labels=c('Not fully minimized','Fully minimized' ) ) 
x1 <- c(1,.9,1,1.1)
y1 <- c(model1.2$reg_table$CI.L[1],model1.2$reg_table$b.r[1], model1.2$reg_table$CI.U[1],model1.2$reg_table$b.r[1])
df1 <- data.frame(x1,y1)
x2 <- c(2,1.9,2,2.1)
y2 <- c(model1.3$reg_table$CI.L[1],model1.3$reg_table$b.r[1], model1.3$reg_table$CI.U[1],model1.3$reg_table$b.r[1])
df2 <- data.frame(x2,y2)
levels( whorsvexp$minanygenf ) <- c( 'Not limited','Limited at least somewhat' )


( box2 <- ggplot( whorsvexp, aes( x=minanygenf, y=logor ) ) +
    geom_boxplot( outlier.shape = NA )  +
    geom_polygon(data=df1, aes(x=x1, y=y1 ), fill=NA, color='red', size=1.25) +
    geom_polygon(data=df2, aes(x=x2, y=y2 ), fill=NA, color='red', size=1.25) +
    geom_point( aes(size = whorsvexp$w, color = mingenfullf ), position = position_jitterdodge(),
                show.legend = F ) +
    scale_color_manual(values=c('Not fully minimized'='black', 'Fully minimized'='red')) +
    ggtitle( 'Effect Size Distributions and Conditional Mean Effect Sizes\nby whether Estimates Limited Genetic Confounding') +
    ylab( 'Natural Log of the Odds Ratio' ) +
    xlab( 'Limited Potential Genetic Confounding?' ) +
    theme( plot.title = element_text( size=14, face='bold' ),
           axis.title.x = element_text( size=12, face='bold'  ),
           axis.title.y = element_text( size=12, face='bold' ),
           axis.text.x = element_text( size=10, face='bold'),
           axis.text.y = element_text( size=10, face = 'bold')) +
    theme(legend.position = "none") + 
    annotate("text", x = 2.25, y =whorsvexp[ whorsvexp$studyname=='Poorisrisak 2010','logor']*.5, label = "Poorisrisak 2010", color='red', fontface='bold') + 
    geom_hline(yintercept = 0, linetype = 'dashed', size = 1, colour = 2 )
)
```

### Sensitivity Analyses for RSV+ Exposure Studies

**Model 1.4:** We run a sensitivity analysis for Model 1.2 using different values for the presumed common correlation among effect sizes from the same study ($\rho$). We'll rerun the model 5 times with the value of $\rho$ taking on values ranging from 0.00 to 1.00 (full range of possible correlaitons) at an interval of 0.20. Then we can see if the model estimates and standard errors are sensitive to our choice of value for $\rho$.

```{r}
sensitivity( model1.2 )
```

The coefficient and standard error estimates are highly similar no matter what value of $\rho$ is selected. Thus, the value of $\rho$ selected seems inconsequential.


**Model 1.5:** Next, we run a model dropping all estimates based on analyses that did not limit any potential confouders (naive estimates), either through the study design or statistical analyses (i.e., naive estimates). Thus, we evaluate whether the estimates in Model 2 are driven by naive estimates, which we expect to be upwardly biased.
```{r}
model1.5 <- robu( logor ~ surveil + preschool + surveil + exp012 + minanygen + minanycoinf + minanyneo + participantrisk, 
                   data = whorsvexp[ whorsvexp$nocohortlab5!='No evidence of limiting confounders', ], 
                   studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) 

print( model1.5 )
```

The negative modifying effect of limiting genetic confounding was robust when removing naive estimates and the intercept (conditional weighted mean log~e~OR) remained positive and significant. Thus, removing naive estimates did not alter our conclusions.

<br>
**Leave-One-Out Analyses:** Finally, we reran model 1.2 36 times, iteratively removing one study (and all of its estimates) at a time to determine whether any one study had enough leverage to alter our main conclusions. The figure below shows estimates on the log~e~(OR) scale for the intercept (panel **a**), the modifying influence of limiting non-RSV co-infections (panel **b**), the modifying influence of limiting genetic confounding (panel *c*), and modifying effect of limiting neonatal health differences (panel *d*). The x-axis shows the estimates on the log~e~OR scale when each individual study is eliminated from the model 1.2 (y-axis). The vertical red dotted line at 0 represents no effect. 

```{r fig.height = 20, fig.width = 20}
levels( looplotdf$parameter) <- c( 'a. Conditional Mean (Intercept)',
                       'b. Limited Influence non-RSV Co-Infections',
                       'c. Limited Influence of Genetic Confounding',
                       'd. Limited Influence of Neonatal Health')
looplot_labeller <- function(variable,value){
  return(looplotlabels[value])
}

( looplot <- ggplot( looplotdf ) +
            geom_segment( aes( x=cilow, y=studynames, xend=ciup, yend=studynames ) ) +
            geom_point( aes( x=est, y=studynames) ) +
            geom_vline( xintercept=0, color='red', linetype='dashed', size=1.5) +
            facet_wrap( ~parameter, scales = 'free_x' ) + 
            expand_limits(x = 0) +
            ggtitle('Leave-One-Out Analysis: RSV LRTI Exposure Studies') +
            xlab( 'Estimate of Modifying Effect: log(Odds Ratio)') +
            ylab('Study Left Out of the Analysis') +
            theme( plot.title = element_text( size=16, face='bold' ),
              axis.title.x = element_text( size=14, face='bold'  ),
              axis.title.y = element_text( size=12, face='bold' ),
              axis.text.x = element_text( size=10, face='bold'),
              axis.text.y = element_text( size=10, face = 'bold'),
              strip.text.x = element_text(size=14, face='bold') ) 
  )
```

This figure shows that, for all four primary parameters of interest, the removal of any one study (and all of its estimates) does not alter whether the 95% confidence interval contains the null value (log~e~OR=0). No individual study had sufficient leverage to alter our primary conclusion. In sum, the effects were robust and not driven by any one study. 

###Subgroup analyses for RSV+ Exposure studies###

**Model 1.6:** We run a new model including only estimates evaluating the association between RSV LRTI and subsequent "asthma" outcomes measured at age $\ge$ 6 years. Estimates were included if the study authors described the corresponding outcome variable as "asthma" as determined by medical records, physician evaluation, and/or a pre-specified study criteria (e.g., three or more wheezing episodes in the past year, use of asthma medications, etc.). It is plausible that findings from the *RSV Exposure* models are driven by transient wheezing episodes early in life. This model focuses only on outcomes present at an age when early life transient wheezing epiosdes have typically resolved. Additionally, all estimates included in this model correspond to outcomes that were measured long after the washout period (30 days) between the exposure and outcome measurements. Thus, we can be highly confident that all wheezing illness outcomes included in this analysis were not merely symptom manifestations of the index RSV LRTI illness (i.e., the exposure and outcome are clearly separate).

First, we create a new dataframe (*whorsvesp_asth6*) including only estimate measuring asthma at age $\ge$ 6 years by selecting the subset of studies with the value of 1 for the variable *asthma6*:

```{r}
whorsvexp_asth6 <- subset( whorsvexp, dxoutcome6 == 1 )
```

Next, we run Model 1.6. Because there are only 15 studies and 42 effect size estimates, it's not feasible to run a model as complex as Model 1.2. Therefore, we first run the model without any effect modifiers. 

```{r}
model1.6 <- robu( logor ~ 1, 
                          data = whorsvexp_asth6, 
                          studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) 

print( model1.6 )

model1.6.est <- round( exp( c(model1.6$reg_table$b.r[1]) ), digits = 2  )
model1.6.lci <- round( exp( c(model1.6$reg_table$CI.L[1]) ), digits = 2  )
model1.6.uci <- round( exp( c(model1.6$reg_table$CI.U[1]) ), digits = 2  )
## Estimates on the OR scale
( model1.6.table <- data.frame(parameter=model1.6$reg_table$labels[1], ConditionalOddsRatio=model1.6.est[1], LCI=model1.6.lci[1], UCI=model1.6.uci[1] ) )
```

The weighted mean effect size is positive and significant: OR = 2.43, 95% CI [1.62, 3.63]. Thus, the effect of RSV LRTI on subsequent wheezing illness does not appear to be driven by estimates evaluating effects of RSV LRTI on transient wheezing episodes in early life. As shown below, there is no evidence that whether estimates were based on analyses limiting genetic confounding, co-infections, or neonatal health markers did not modify the effect. As the sample size was much smaller than in model 1.2, there was less power and we entered only one effect modifier at a time.

**Model 1.6a:** Rerun Model 1.6 including the variable coding whether or not the estimates were based on analyses limiting genetic confounding (*minanygenf*) as an effect modifier.

```{r}
( model1.6a <- robu( logor ~ minanygenf, 
                          data = whorsvexp_asth6, 
                          studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) )
```

**Model 1.6b:** Rerun Model 1.6 including the variable coding whether or not the estimates were based on analyses limiting non-RSV co-infections (*minanycoinf*) as an effect modifier.

```{r}
( model1.6b <- robu( logor ~ minanycoinf, 
                          data = whorsvexp_asth6, 
                          studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) )
```

**Model 1.6c:** Rerun Model 1.6 including the variable coding whether or not the estimates were based on analyses limiting differences in neonatal health markers (*minanyneo*) as an effect modifier.

```{r}
( model1.6c <- robu( logor ~ minanyneo, 
                          data = whorsvexp_asth6, 
                          studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) )
```

<br>
<br>
**Model 1.7:** We also evaluated whether the association between RSV LRTI and subsequent wheezing illness was significant among the subset of estimates from samples in which all children had a family history of asthma or atopy.

```{r}
whoatopyexp <- subset( whoatopy, rsvexp == 'RSV Exposure Studies' )
( model1.7 <- robu( logor ~ 1, 
                          data = whoatopyexp, 
                          studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) )

model1.7.est <- round( exp( c(model1.7$reg_table$b.r[1]) ), digits = 2  )
model1.7.lci <- round( exp( c(model1.7$reg_table$CI.L[1]) ), digits = 2  )
model1.7.uci <- round( exp( c(model1.7$reg_table$CI.U[1]) ), digits = 2  )
## Estimates on the OR scale
( model1.7.table <- data.frame(parameter=model1.7$reg_table$labels[1], ConditionalOddsRatio=model1.7.est[1], LCI=model1.7.lci[1], UCI=model1.7.uci[1] ) )
```

The weighted mean log~e~(OR) effect size is greater than 0 in these 7 studies (40 estimates), but notably smaller than in the primary analyses: OR = 1.72, 95% CI[1.19, 2.49]. This raises the possibility that RSV LRTI might have a smaller effect among children who have a high genetic loading for asthma/atopy, though our analyses could not test this explicitly. There were only 2 studies providing estimates from the specific subpopulation of children whose parents denied family history of asthma/atopy, precluding meaningful meta-analytic modeling.

We intended to conduct a subgroup analysis evaluating the mean effect size for the association between RSV LRTI and subsequent wheezing outcomes among children with early atopic sensitization (age $\le$ 2), but there were insufficient data available.


## *RSV Prophylaxis* studies
In this section, we evaluate whether there is evidence that high-risk infants receiving RSV immunoprophylaxis have lower risk of subsequent wheezing illness. There are 8 *RSV Prophylaxis* studies (2 RCTs and 6 non-randomized studies) providing 22 estimates for the primary analyses. 

First, we create a data frame with only RSV+ Immunoprophylaxis Studies. There are 16 estimates from non-randomized prophylaxis studies and 7 from the two RCTs. 
```{r}
whoprophyl <- subset( whoprimary1, comptype == 'Prophylaxis vs No Prophylaxis' )
whoprophyl$rct <- factor( whoprophyl$rct, level=0:1, labels = c('Non-Randomized','RCT'))
table( whoprophyl$rct )
```

```{r echo=F}
whoprophyl$eslab <- c('Parent-report asthma','Physician dx asthma','Wheeze ages 1-3',
                      'Recurrent wheeze','Any wheeze','Serious wheeze','3+ med.-attended wheeze',
                      'Asthma (multivariable)','Asthma (propensity-matched)','Asthma (propensity-adj.)','Atopic asthma',
                      'Dx. recurrent wheeze','Dx. recurrent wheeze','Dx. recurrent wheeze',
                      'Recurrent wheeze (not dx.)','Parent report asthma','Wheezing episode',
                      'Wheezing episode','Asthma hospital/rx (frailty model)',
                      'Asthma hospital (frailty model)','Asthma hospital/rx (cox model)',
                      'sthma hospital (cox model)','Recurrent wheeze')

whoprophyl$ageoutcome <- c('6','6','1-3','1','1','1-3','1-3','5','5','5','6','6','3','4','4',
                           '2','2','9','4','4','4','4','3'
                           )
whoprophyl$logor2 <- round( whoprophyl$logor, digits=2)
```

**Model 2.1:** We run a model evaluating the weighted mean average effect size across all *RSV Prophylaxis* studies. One effect modifier, coding whether the study used an RCT or a non-randomized study design, was included in the model. 
```{r}
print( model2.1 <- robu( logor ~ rct, 
                          data = whoprophyl, 
                          studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) )
```

The number of *df* for the RCT parameter estimate is too small to be trustworthy. This is likely due to the small number of estimates provided by RCTs. 

**Model 2.2:** We rerun Model 2.1 without including the effect modifier and get a single estimate for all prophylaxis studies.
```{r}
print( model2.2 <- robu( logor2 ~ 1, 
                          data = whoprophyl, 
                          studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) )

model2.2.est <- round( exp( c(model2.2$reg_table$b.r[1]) ), digits = 2  )
model2.2.lci <- round( exp( c(model2.2$reg_table$CI.L[1]) ), digits = 2  )
model2.2.uci <- round( exp( c(model2.2$reg_table$CI.U[1]) ), digits = 2  )
## Estimates on the OR scale
( model2.2.table <- data.frame(parameter=model2.2$reg_table$labels[1], OddsRatio=model2.2.est[1], LCI=model2.2.lci[1], UCI=model2.2.uci[1] ) )
```
The estimate is positive, log~e~(OR)=0.19 (OR=1.21), but the confidence interval easily overlaps 0, so we **cannot** be confident that those not receiving RSV prophylaxis (who presumably have greater exposure to RSV LRTI) are at any greater odds of having subsequent wheezing illness.


**Model 2.3:** One of the primary threats to inference in non-randomized prophylaxis trials is that those receiving RSV immunoprophylaxis have more severe health problems and are thus more likely to receive the intervention. This potential imbalance between RSV immunoprophylaxis exposure group and comparator group might result in a spurious positive association between RSV immunoprophylaxis and subsequent wheezing illness even if it is truly protective (i.e., confounding by indication). As a sensitivity analysis, we removed two studies (dos Santos Simoes et al. 2018 and Prais et al. 2016) in which there was no clear attempt to minmize confounding by indication and reran Model 2.2:
```{r}
whoprophylsubset <- subset( whoprophyl, studyname != 'Prais 2016' & studyname != 'dos Santos Simoes 2018' )

print( model2.3 <- robu( logor ~ 1, 
                          data = whoprophylsubset, 
                          studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) )

model2.3.est <- round( exp( c(model2.3$reg_table$b.r[1]) ), digits = 2  )
model2.3.lci <- round( exp( c(model2.3$reg_table$CI.L[1]) ), digits = 2  )
model2.3.uci <- round( exp( c(model2.3$reg_table$CI.U[1]) ), digits = 2  )
## Estimates on the OR scale
( model2.3.table <- data.frame(parameter=model2.3$reg_table$labels[1], OddsRatio=model2.3.est[1], LCI=model2.3.lci[1], UCI=model2.3.uci[1] ) )
```

The weighted mean effect size is larger when removing the two studies that did not reduce risk of confounding by indication, but the confidence interval still easily overlaps 0. Therefore, we cannot conclude with confidence that those receiving RSV immunoprophylaxis have lower odds of developing subsequent wheezing illness. 

Below is a forest plot summarizing results of models 2.2 and 2.3, evaluating the effect of RSV immunoprophylaxis on wheezing illness. Black squares with lines through them represent individual effect size estimates and their 95% confidence intervals, with the size of the squares proportional to their weight in the analysis. The blue diamond represents the weighted mean effect size and 95% confidence interval for estimates from RCTs and observational studies clearly limiting confounders (i.e., the mean effect size without naive estimates). The red diamond represents the weighted mean effect including all studies, including those from observational studies that did not clearly limit potential confounders. The vertical dotted line represents a null effect size: log~e~OR = 0.
```{r, fig.height=10, fig.width=8}

yaxis.or <- c(4:6,9,17:19,22:24,27:28,31:34,39:43,46:47) 
yaxis.studylab <- c(7,10,20,25,29,35,44,48)
yaxis.studytype <- c(11,34,47)
yaxis.summary <- c(1,13)
yaxis.studytypelab <- c('Observational: Naive estimates',
                        'Observational: Limit confounders',
                        'RCTs')
yaxis.summarylab <- c('Mean OR: All Studies','Mean OR: No naive estimates')

par( mar= c(6.2,16,1,12), xpd=T, oma=c( 0,0,0,0 ) ) 
with( prophylplot1, plot( logor, yaxis.or, type = 'p', pch = 15, 
                         xlim = c( -3, 3 ), ylim =c( 0, max(yaxis.or)*1.1), 
                         bty = 'n', yaxt = 'n', ylab = '', cex = weight*.8, 
                         xlab = '', cex.axis = .8 ) )
## Arrows indicating direction of effect
arrows( x0 = -0.05, x1 = -3, y0 = -5.2, y1 = -5.2, xpd=T, length = .15, lwd = 2, col = 1 ) 
arrows( x0 = 0.05, x1 = 3, y0 = -5.2, y1 = -5.2, xpd=T, length = .15, lwd = 2, col = 'firebrick' ) 
text( c(-1.5, 1.5), c(-7,-7), labels = c("Favors no\n causal effect","Favors\ncausal effect"), xpd=T,
      cex = .85, col = c(1,'firebrick'), font = 2)
## x-axis label
text( labels="log(Odds Ratio)", font=2, cex=1, x = 0, y = -9.5, xpd = T )
## Confidence intervals for effect sizes
with( prophylplot1, segments( x0 = logor.cilow, x1=logor.ciup, y0=yaxis.or, y1=yaxis.or, 
                             lty = 1, lwd=1.35, col = 1) )
## Labels for effect sizes and studies
with( prophylplot1, mtext( text = eslab, side = 2, outer = F, at = yaxis.or, las = 2, cex = .80  ) )
with( prophylplot1[ !duplicated(prophylplot1$studyname), ], 
      mtext( text = studyname, side = 2, outer = F, font = 2, 
             at = yaxis.studylab, las = 2, cex=.85, col = 1  ) )
#polygon( x=c(-3.53,0.207,3.95,0.207,-3.53), y=c(35.5,35,35.5,36,35.5))
## Mean effect size polygons
polygon( x=c(model2.2$reg_table$CI.L, model2.2$reg_table$b.r, 
             model2.2$reg_table$CI.U, model2.2$reg_table$b.r,
             model2.2$reg_table$CI.L), 
         y=c(1,0,1,2,1),col='firebrick',border='firebrick')
mtext( 'Mean: All Estimates', side = 2, outer = F, font=2, at = 1, 
       col = 'firebrick', las=2, cex = 1.1  )
polygon( x=c(model2.3$reg_table$CI.L, model2.3$reg_table$b.r, 
             model2.3$reg_table$CI.U, model2.3$reg_table$b.r,
             model2.3$reg_table$CI.L), 
         y=c(15,14,15,16,15),col='dodgerblue',border='dodgerblue')
mtext( 'Mean: Without Naive Estimates', side = 2, outer = F, 
       font = 2, at = 15, col = 'dodgerblue', las=2, cex=1.1)
## Subsection labels
text( labels = c( 'RCTs','Observational: Limit confounders','Observational: Naive etimates' ), 
                  x = c( -3, -3, -3), y = c(49.5, 36.5, 11.5), font = 2, xpd = T, cex = 1.1, pos = 2,
      col=1) 
segments( x0 = c(-15,-15,-15), x1 = c(15,15,15), y0=c(50.5,37.5,12.5), col='dark gray', lwd = 2 )
## Zero effect guideline
with( prophylplot1, segments( x0 = 0, x1=0, y0=-2, y1=max(yaxis.or)*1.05, lty = 3, lwd=2, col = 1) ) 
## Text in right margin
with( prophylplot1, text( x=4.5, y = yaxis.or+.05, labels = logor.plot, las = 2, xpd = T, cex=.8  ) )
with( prophylplot1, text( x=6.5, y = yaxis.or, labels = logor.cif, las = 2, xpd = T, cex=.8   ) )
with( prophylplot1, text( x=8.5, y = yaxis.or, labels = ageoutcome, las = 2, xpd = T, cex=.8    ) )
with( prophylplot1, text( x=4.5, y = max(yaxis.or)+5, labels = 'log(OR)', las = 2, font = 2, cex=.9, xpd=T  ) )
with( prophylplot1, text( x=6.5, y = max(yaxis.or)+5, labels = '95% CI', las = 2, font = 2, cex=.9, xpd=T   ) )
with( prophylplot1, text( x=8.5, y = max(yaxis.or)+5, labels = 'Age\n(years)', 
                          las = 2, font = 2, cex=.9, xpd=T ) )
with( prophylplot1, text( x=4.5, y = 1+.05, labels = '0.21', las = 2, font = 2, col = 'firebrick', cex = .9, xpd = T ) )
with( prophylplot1, text( x=6.5, y = 1, labels = '-0.31, 0.72', las = 2, font = 2, col = 'firebrick', cex = .9, xpd = T  ) )
with( prophylplot1, text( x=4.5, y = 15+.055, labels = '0.34', las = 2, font = 2, col = 'dodgerblue', cex = .9, xpd = T  ) )
with( prophylplot1, text( x=6.5, y = 15, labels = '-0.14, 0.83', las = 2, font = 2, col = 'dodgerblue', cex = .9, xpd = T ) )
## Main title
with( prophylplot1, text( x=-12, y = max(yaxis.or)+5, labels = 'RSV Immunoprophylaxis Studies', las = 2, font = 2, 
                          col = 1, cex = 1.5, xpd = T, pos=4 ) )
```



**Model 2.4:** Finally, we run a model including estimates from only the two immunoprophyalxis RCTs. As there were only two studies and seven estimates, we expect a large confidence interval around the weighted mean effect size estimate. The RCTs have a major advantage of essentially eliminating the threat of confounding by indication given that participant characteristics could not affect the likelihood of their receiving the intervention. 
```{r}
print( model2.4 <- robu( logor ~ 1, 
                          data = whoprophyl[ whoprophyl$rct == 'RCT', ], 
                          studynum = studyid, var.eff.size = se_logor^2, rho = .8, small = T ) )

model2.4.est <- round( exp( c(model2.4$reg_table$b.r[1]) ), digits = 2  )
model2.4.lci <- round( exp( c(model2.4$reg_table$CI.L[1]) ), digits = 2  )
model2.4.uci <- round( exp( c(model2.4$reg_table$CI.U[1]) ), digits = 2  )
## Estimates on the OR scale
( model2.4.table <- data.frame(parameter=model2.4$reg_table$labels[1], ConditionalOddsRatio=model2.4.est[1], LCI=model2.4.lci[1], UCI=model2.4.uci[1] ) )
```

As expected, the confidence interval is very large, spanning OR values from 0.03 to 51.72. So we cannot rule out that getting a placebo instead of RSV immunoprophylaxis has a protective effect or a highly damaging effect.

In sum, our analyses provide no evidence that high-risk infants **not receiving RSV immunoprophylaxis** are at any greater odds of developing subsequent wheeze than their counterparts who receive RSV immunoprophylaxis.  